# SPDX-FileCopyrightText: Copyright Â© 2026, Jared Cook
# SPDX-License-Identifier: AGPL-3.0-or-later

# This is a subroutine of pkg-source-build-routine
---
- name: Collect running user facts
  ansible.builtin.include_tasks: utilities/sudo_user_facts.yml
  when: sudo_user is not defined

- name: Checkinstall
  when: checkinstall is defined
  block:
    - name: Ensure checkinstall generated installation file directory exists
      ansible.builtin.file:
        path: "{{ checkinstall.pakdir }}"
        state: directory
        owner: "{{ sudo_user }}"
        group: "{{ sudo_user }}"
        mode: "0755"
      when: checkinstall.pakdir is defined

    - name: Debug rendered template
      ansible.builtin.debug:
        msg: "{{ lookup('template', 'utilities/checkinstall.j2') }}"

    - name: Run checkinstall
      ansible.builtin.command:
        cmd: "{{ lookup('template', 'utilities/checkinstall.j2') }}"
        chdir: "{{ autobuild.git_repo.directory }}"
      become: true
      become_user: root
      when: autobuild.build.script == "make"

    # TODO: when meson-ninja is true make sure meson-install is installed or install.

    - name: Run checkinstall
      ansible.builtin.shell: |
        {{ lookup('template', 'utilities/checkinstall.j2') }}
      args:
        executable: /bin/bash
        chdir: "{{ autobuild.git_repo.directory }}/build"
      become: true
      become_user: root
      when: autobuild.build.script == "cmake" or autobuild.build.script == "meson-ninja"
